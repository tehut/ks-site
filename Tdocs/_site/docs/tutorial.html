
<h1 id="tutorial">Tutorial</h1>

<p>One of the strengths of <strong>ksonnet</strong> mixin libraries is their ability
to allow users to separate a Kubernetes application into several
modular components.</p>

<p>For example, a team might split into application and logging subteams.
Rather than writing a single YAML file that combines them into a
single Kubernetes app, the logging team can simply write a mixin
library that the application team can use to add logging to their
Kubernetes application definition.</p>

<p>In this tutorial, we will explore how such libraries are constructed,
using a mixin library for <a href="http://www.fluentd.org/architecture">fluentd</a> (hosted in the official
<a href="https://github.com/ksonnet/mixins/tree/master/incubator/fluentd">mixins repository</a>). Specifically, we see how one team
writing an app using <a href="https://www.elastic.co/products">Elasticsearch</a> can use the Fluentd
mixin library to use easily configure Fluentd to tail the
Elasticsearch logs and pass them Kibana to be rendered in a dashboard.</p>

<p>For more information about Elasticsearch and Kibana, see <a href="https://www.elastic.co/products">the Elastic
website</a>. For <code class="highlighter-rouge">fluentd</code>, see <a href="http://www.fluentd.org/architecture">the Fluentd website</a>.</p>

<h2 id="requirements-to-build-your-own-mixins">Requirements to build your own mixins</h2>

<p>If you want to build your own mixin libraries, or write <strong>ksonnet</strong>
using the built-in mixins, you need to perform the following tasks.
For details, see the <a href="../readme.md" title="ksonnet readme">readme</a>.</p>

<ul>
  <li>Install <strong>Jsonnet</strong>, version 0.9.4 or later</li>
  <li>Clone the <strong>ksonnet</strong> repository locally</li>
  <li>Install and configure the Visual Studio Code extension (optional)</li>
  <li>Create a test Kubernetes cluster</li>
</ul>

<h2 id="architecture-and-design">Architecture and design</h2>

<p>The idea of the application is for Elasticsearch to emit logs to
standard out, and for Fluentd to tail those logs and send them to
Kibana for rendering.</p>

<p>In Kubernetes, accessing the <code class="highlighter-rouge">Pod</code> logs involves:</p>

<ul>
  <li>Giving the Fluentd container permissions to access the <code class="highlighter-rouge">Pod</code> logs,
 and</li>
  <li>Appending volume mounts that contain the <code class="highlighter-rouge">Pod</code> logs, to the Fluentd
 container, so that it can access them.</li>
</ul>

<p>We’ll walk through the key parts of the files in example in detail,
but at a high level this implementation is broken up as:</p>

<ul>
  <li>
    <p>A <code class="highlighter-rouge">DaemonSet</code> that causes Fluentd to run once on every machine, so
that it can tail <code class="highlighter-rouge">Pod</code> logs for Elasticsearch running anywhere in
the cluster.</p>

    <p>On its own, this <code class="highlighter-rouge">DaemonSet</code> only contains the core Fluentd
application definition. For example, it has no permissions to access
(<em>e.g.</em>) <code class="highlighter-rouge">Pod</code> Logs, or the volume mounts required to access them.</p>
  </li>
  <li>A separate mixin that defines the <code class="highlighter-rouge">VolumeMounts</code> and <code class="highlighter-rouge">Volumes</code> that
the <code class="highlighter-rouge">DaemonSet</code> requires to access the <code class="highlighter-rouge">Pod</code> Logs.</li>
  <li>A separate mixin that configures the access permissions for the
<code class="highlighter-rouge">DaemonSet</code></li>
  <li>The RBAC objects that the cluster administrator must send to the
cluster so that the <code class="highlighter-rouge">ServiceAccount</code> associated with Fluentd can be
granted permission to obtain the <code class="highlighter-rouge">Pod</code> logs.</li>
</ul>

<p>The power of this approach lies in its separation of concerns: an
application developer can define the <code class="highlighter-rouge">DaemonSet</code>, while a cluster
admin can define the access permissions that this or any other
<code class="highlighter-rouge">DaemonSet</code> might require. The <code class="highlighter-rouge">DaemonSet</code> or the access permissions
can be modified as needed without requiring a complete cluster
reconfiguration. Indeed, as the <code class="highlighter-rouge">DaemonSet</code> mixin demonstrates, the
details of the <code class="highlighter-rouge">DaemonSet</code> (in this case, the <code class="highlighter-rouge">Volumes</code> and
<code class="highlighter-rouge">VolumeMounts</code>) can also be adjusted without having to touch the base
<code class="highlighter-rouge">DaemonSet</code> definition.</p>

<h3 id="define-mixins-to-configure-access-to-pod-logs">Define mixins to configure access to pod logs</h3>

<p>Let’s look at how we can decouple the pieces of a complete Fluentd
configuration, so that your logging team, for example, can write just
the core of a Fluentd DaemonSet, and then write a <strong>ksonnet</strong> library
that lets you customize key details of the configuration as needed.</p>

<p><code class="highlighter-rouge">fluentd-es-ds.jsonnet</code> defines a basic DaemonSet, and then adds access permissions to it.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// daemonset</span>
<span class="nx">local</span> <span class="nx">ds</span> <span class="o">=</span>
  <span class="c1">// base daemonset</span>
  <span class="nx">fluentd</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">daemonSetBuilder</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="o">+</span>
  <span class="c1">// add configuration for access to pod logs</span>
  <span class="nx">fluentd</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">daemonSetBuilder</span><span class="p">.</span><span class="nx">configureForPodLogs</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>

 <span class="c1">// create access permissions for pod logs</span>
 <span class="nx">local</span> <span class="nx">rbacObjs</span> <span class="o">=</span> <span class="nx">fluentd</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">rbacForPodLogs</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</code></pre></div></div>

<p>Note that our base DaemonSet can’t do anything. It doesn’t know where
the pod logs that it needs are – it needs Volumes and VolumeMounts to
provide this information. It also needs access permissions, provided
with RBAC. So we add these items separately. Let’s look more closely
at the advantages of this approach.</p>

<p>In <code class="highlighter-rouge">fluentd.libsonnet</code>, we define the <code class="highlighter-rouge">daemonSet</code> mixin. Here is where
we start to see the real power of <strong>ksonnet</strong> mixins at work. This
mixin specifies the VolumeMounts and Volumes that Fluentd requires
separately from the DaemonSet definition itself. This approach lets us
decouple application definitions from deployment details.</p>

<p>Note particularly in the following snippet the <code class="highlighter-rouge">containerSelector</code>
parameter to <code class="highlighter-rouge">addHostMountedPodLogs</code>. We pass this function to
<code class="highlighter-rouge">ds.mapContainers</code> to iterate over our containers (in this case, our
Fluentd containers) and add the VolumeMounts that they need. (The
details of the pod logs have also been abstracted away to their own
function.)</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">mixin</span><span class="p">::</span> <span class="p">{</span>
    <span class="nl">daemonSet</span><span class="p">::</span> <span class="p">{</span>
      <span class="c1">// Takes two volume names and produces a</span>
      <span class="c1">// mixin that mounts the Kubernetes pod logs into a set of</span>
      <span class="c1">// containers specified by `containerSelector`.</span>
      <span class="nx">addHostMountedPodLogs</span><span class="p">(</span>
        <span class="nx">varlogName</span><span class="p">,</span> <span class="nx">podlogsName</span><span class="p">,</span> <span class="nx">containerSelector</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="kc">true</span>
      <span class="p">)::</span>
        <span class="nx">local</span> <span class="nx">podLogs</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parts</span><span class="p">.</span><span class="nx">podLogs</span><span class="p">(</span><span class="nx">varlogName</span><span class="p">,</span> <span class="nx">podlogsName</span><span class="p">);</span>

        <span class="c1">// Add volume to DaemonSet.</span>
        <span class="nx">ds</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">volumes</span><span class="p">([</span>
          <span class="nx">podLogs</span><span class="p">.</span><span class="nx">varLogVolume</span><span class="p">,</span>
          <span class="nx">podLogs</span><span class="p">.</span><span class="nx">podLogVolume</span><span class="p">,</span>
        <span class="p">])</span> <span class="o">+</span>

        <span class="c1">// Iterate over a specified set of containers to add the VolumeMounts</span>
        <span class="nx">ds</span><span class="p">.</span><span class="nx">mapContainers</span><span class="p">(</span>
          <span class="kd">function</span> <span class="p">(</span><span class="nx">c</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">containerSelector</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span>
            <span class="nx">then</span>
              <span class="nx">c</span> <span class="o">+</span> <span class="nx">container</span><span class="p">.</span><span class="nx">volumeMounts</span><span class="p">([</span>
                <span class="nx">podLogs</span><span class="p">.</span><span class="nx">varLogMount</span><span class="p">,</span>
                <span class="nx">podLogs</span><span class="p">.</span><span class="nx">podLogMount</span><span class="p">,</span>
              <span class="p">])</span>
            <span class="k">else</span> <span class="nx">c</span><span class="p">),</span>
    <span class="p">},</span>
  <span class="p">},</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">daemonSetBuilder</code> that we used to create the DaemonSet calls our
<code class="highlighter-rouge">daemonSet</code> mixin, and also defines the <code class="highlighter-rouge">configureForPodLogs</code> function
that the DaemonSet needs. But the DaemonSet itself, from our first
code snippet, doesn’t need to know any of these details:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">daemonSetBuilder</span><span class="p">::</span> <span class="p">{</span>
      <span class="k">new</span><span class="p">(</span><span class="nx">config</span><span class="p">)::</span> <span class="p">{</span>
        <span class="nx">toArray</span><span class="p">()::</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="nx">daemonSet</span><span class="p">],</span>
        <span class="nx">daemonSet</span><span class="p">::</span> <span class="nx">$</span><span class="p">.</span><span class="nx">parts</span><span class="p">.</span><span class="nx">daemonSet</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">daemonSet</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">tag</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">namespace</span><span class="p">)</span>
      <span class="p">},</span>

      <span class="c1">// access configuration</span>
      <span class="nx">configureForPodLogs</span><span class="p">(</span>
        <span class="nx">config</span><span class="p">,</span>
        <span class="nx">varlogVolName</span><span class="o">=</span><span class="s2">"varlog"</span><span class="p">,</span>
        <span class="nx">podLogsVolName</span><span class="o">=</span><span class="s2">"varlibdockercontainers"</span><span class="p">,</span>
      <span class="p">)::</span>
        <span class="p">{}</span> <span class="o">+</span> <span class="p">{</span>
          <span class="nx">daemonSet</span><span class="o">+</span><span class="p">::</span>
            <span class="nx">$</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">daemonSet</span><span class="p">.</span><span class="nx">addHostMountedPodLogs</span><span class="p">(</span>
              <span class="nx">varlogVolName</span><span class="p">,</span>
              <span class="nx">podLogsVolName</span><span class="p">,</span>
              <span class="nx">$</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">containerNameInSet</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">container</span><span class="p">.</span><span class="nx">name</span><span class="p">))</span> <span class="o">+</span>
            <span class="c1">// RBAC and service account</span>
            <span class="nx">ds</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">template</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">serviceAccountName</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">accountName</span><span class="p">)</span>
        <span class="p">},</span>
    <span class="p">},</span>
</code></pre></div></div>

<p>In the previous snippet, we notice that we’re specifying a Service
Account, and RBAC is involved. It’s time to define our RBAC objects so
that our Fluentd access permissions mean something.</p>

<h3 id="define-rbac-objects">Define RBAC objects</h3>

<p>We define RBAC objects separately so that they can be managed
independently of the rest of the cluster configuration. This approach
lets cluster admins and application developers work independently.
Your cluster admins can determine and define access permissions that
can be applied to application configurations with a few lines of code.</p>

<p>Defining access permissions in Kubernetes requires definition of the
RBAC objects that are encapsulated in this definition (from
<code class="highlighter-rouge">fluentd.libsonnet</code>).</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">admin</span><span class="p">::</span> <span class="p">{</span>
      <span class="nx">rbacForPodLogs</span><span class="p">(</span><span class="nx">config</span><span class="p">)::</span>
        <span class="nx">$</span><span class="p">.</span><span class="nx">parts</span><span class="p">.</span><span class="nx">rbac</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">rbac</span><span class="p">.</span><span class="nx">accountName</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">namespace</span><span class="p">),</span>
    <span class="p">},</span>
</code></pre></div></div>

<p>Let’s unpack this snippet.</p>

<p><code class="highlighter-rouge">fluentd.libsonnet</code> also defines all the required RBAC objects. Note
especially that we abstract the attributes of the Service Account
separately and assign their values in a separate <code class="highlighter-rouge">config</code> object. This
approach lets us make sure that the correct Service Account is
appropriately associated with all required objects.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nx">rbac</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">)::</span>
      <span class="nx">local</span> <span class="nx">metadata</span> <span class="o">=</span> <span class="nx">svcAccount</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span>
        <span class="nx">svcAccount</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">metadata</span><span class="p">.</span><span class="nx">namespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">);</span>

      <span class="nx">local</span> <span class="nx">hcServiceAccount</span> <span class="o">=</span> <span class="nx">svcAccount</span><span class="p">.</span><span class="k">new</span><span class="p">()</span> <span class="o">+</span>
        <span class="nx">metadata</span><span class="p">;</span>

      <span class="nx">local</span> <span class="nx">hcClusterRole</span> <span class="o">=</span>
        <span class="nx">clRole</span><span class="p">.</span><span class="k">new</span><span class="p">()</span> <span class="o">+</span>
        <span class="nx">metadata</span> <span class="o">+</span>
        <span class="nx">clRole</span><span class="p">.</span><span class="nx">rules</span><span class="p">(</span>
          <span class="nx">rule</span><span class="p">.</span><span class="k">new</span><span class="p">()</span> <span class="o">+</span>
          <span class="nx">rule</span><span class="p">.</span><span class="nx">apiGroups</span><span class="p">(</span><span class="s2">"*"</span><span class="p">)</span> <span class="o">+</span>
          <span class="nx">rule</span><span class="p">.</span><span class="nx">resources</span><span class="p">([</span><span class="s2">"pods"</span><span class="p">,</span> <span class="s2">"nodes"</span><span class="p">])</span> <span class="o">+</span>
          <span class="nx">rule</span><span class="p">.</span><span class="nx">verbs</span><span class="p">([</span><span class="s2">"list"</span><span class="p">,</span> <span class="s2">"watch"</span><span class="p">])</span>
        <span class="p">);</span>

      <span class="nx">local</span> <span class="nx">hcClusterRoleBinding</span> <span class="o">=</span>
        <span class="nx">clRoleBinding</span><span class="p">.</span><span class="k">new</span><span class="p">()</span> <span class="o">+</span>
        <span class="nx">metadata</span> <span class="o">+</span>
        <span class="nx">clRoleBinding</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">roleRef</span><span class="p">.</span><span class="nx">apiGroup</span><span class="p">(</span><span class="s2">"rbac.authorization.k8s.io"</span><span class="p">)</span> <span class="o">+</span>
        <span class="nx">clRoleBinding</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">roleRef</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span>
        <span class="nx">clRoleBinding</span><span class="p">.</span><span class="nx">mixin</span><span class="p">.</span><span class="nx">roleRef</span><span class="p">.</span><span class="nx">mixinInstance</span><span class="p">({</span><span class="na">kind</span><span class="p">:</span> <span class="s2">"ClusterRole"</span><span class="p">})</span> <span class="o">+</span>
        <span class="nx">clRoleBinding</span><span class="p">.</span><span class="nx">subjects</span><span class="p">(</span>
          <span class="nx">subject</span><span class="p">.</span><span class="k">new</span><span class="p">()</span> <span class="o">+</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">name</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">namespace</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span>
          <span class="p">{</span><span class="nl">kind</span><span class="p">:</span> <span class="s2">"ServiceAccount"</span><span class="p">}</span>
        <span class="p">);</span>

</code></pre></div></div>

<p>In <code class="highlighter-rouge">fluentd-es-ds.jsonnet</code> we define our config thus:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">local</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">namespace</span><span class="p">::</span> <span class="s2">"elasticsearch"</span><span class="p">,</span>
  <span class="na">container</span><span class="p">::</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">::</span> <span class="s2">"fluentd-es"</span><span class="p">,</span>
    <span class="na">tag</span><span class="p">::</span> <span class="s2">"1.22"</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">daemonSet</span><span class="p">::</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">::</span> <span class="s2">"fluentd-es-v1.22"</span><span class="p">,</span>
  <span class="p">},</span>
  <span class="na">rbac</span><span class="p">::</span> <span class="p">{</span>
    <span class="na">accountName</span><span class="p">::</span> <span class="s2">"fluentd-serviceaccount"</span>
  <span class="p">},</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The relevant fields here are <code class="highlighter-rouge">namespace</code> and <code class="highlighter-rouge">AccountName</code>, which we
pass as the arguments that our RBAC snippet needs when it calls the
<code class="highlighter-rouge">rbac</code> function.</p>

<h2 id="wrap-it-all-up">Wrap it all up</h2>

<p>Here’s where we started, with our simple DaemonSet, its pod logging,
and its access permissions. But now you’ve seen what’s going on
underneath – not just how the functions for adding pod logs and
permissions are clearly separated, but how we can customize them as
needed without having to rewrite the entire configuration.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// daemonset</span>
<span class="nx">local</span> <span class="nx">ds</span> <span class="o">=</span>
  <span class="c1">// base daemonset</span>
  <span class="nx">fluentd</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">daemonSetBuilder</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="o">+</span>
  <span class="c1">// add configuration for access to pod logs</span>
  <span class="nx">fluentd</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">daemonSetBuilder</span><span class="p">.</span><span class="nx">configureForPodLogs</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>

 <span class="c1">// create access permissions for pod logs</span>
 <span class="nx">local</span> <span class="nx">rbacObjs</span> <span class="o">=</span> <span class="nx">fluentd</span><span class="p">.</span><span class="nx">app</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">rbacForPodLogs</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="explore-further">Explore further</h2>

<p>The GitHub example directory also includes the generated JSON files.
Examine them to help understand the details of how <strong>ksonnet</strong>’s
decomposition and abstraction are compiled into complete
configurations.</p>

<p>As you start to write your own custom mixins, look also at how we
break down the basic <strong>ksonnet</strong> imports into smaller component
objects for easier manipulation.</p>

<p>And feel free to contribute your own examples to our mixins
repository!</p>

